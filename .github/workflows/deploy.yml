name: Deploy to GitHub Pages

on:
  # Trigger deployment on push to main branch
  push:
    branches: [ main ]
  # Allow manual triggering
  workflow_dispatch:

# Grant permissions for deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Test the website before deployment
  test:
    name: Run Tests Before Deployment
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Run Browser Tests
      run: |
        npm install
        # Simple browser test - just verify HTML loads without errors
        if command -v python3 >/dev/null 2>&1; then
          python3 -c "
import http.server
import socketserver
import threading
import time
import urllib.request

# Start simple HTTP server
PORT = 8000
Handler = http.server.SimpleHTTPRequestHandler

with socketserver.TCPServer((\"\", PORT), Handler) as httpd:
    # Start server in background thread
    thread = threading.Thread(target=httpd.serve_forever)
    thread.daemon = True
    thread.start()
    
    # Give server time to start
    time.sleep(2)
    
    # Test loading index.html
    try:
        response = urllib.request.urlopen(f'http://localhost:{PORT}/index.html')
        if response.getcode() == 200:
            print('‚úÖ Main page loads successfully')
        else:
            print('‚ùå Main page failed to load')
    except Exception as e:
        print(f'‚ùå Error loading main page: {e}')
        
    # Test loading a quest page
    try:
        response = urllib.request.urlopen(f'http://localhost:{PORT}/physics/quest-1-measurements.html')
        if response.getcode() == 200:
            print('‚úÖ Quest page loads successfully')
        else:
            print('‚ùå Quest page failed to load')
    except Exception as e:
        print(f'‚ùå Error loading quest page: {e}')
          "
        else
          echo "‚ö†Ô∏è Python not available, skipping browser tests"
        fi
        
    - name: Validate HTML syntax
      run: |
        # Simple HTML validation - check for basic syntax
        echo "üîç Validating HTML files..."
        find . -name "*.html" -type f | while read file; do
          echo "Checking: $file"
          if grep -q "<!DOCTYPE html>" "$file" && grep -q "</html>" "$file"; then
            echo "‚úÖ $file - Basic HTML structure valid"
          else
            echo "‚ö†Ô∏è $file - HTML structure may be incomplete"
          fi
        done

  # Deploy to GitHub Pages
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: test
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: .
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  # Post-deployment verification
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: Wait for deployment
      run: sleep 30
      
    - name: Check deployed site
      run: |
        DEPLOY_URL="https://nisithachamod73-byte.github.io/first-project/"
        echo "üîç Checking deployment at: $DEPLOY_URL"
        
        # Use curl to check if site is accessible
        if command -v curl >/dev/null 2>&1; then
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOY_URL" || echo "000")
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ Site deployed successfully (HTTP 200)"
            echo "üåê Live site: $DEPLOY_URL"
          else
            echo "‚ö†Ô∏è Site deployment check failed (HTTP $STATUS)"
            echo "This might be normal - GitHub Pages can take a few minutes to deploy"
          fi
        else
          echo "‚ö†Ô∏è curl not available, skipping deployment check"
          echo "üåê Live site: $DEPLOY_URL"
        fi